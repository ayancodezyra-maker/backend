// Auth controller
import { supabase } from "../config/supabaseClient.js";
import jwt from "jsonwebtoken";
import dotenv from "dotenv";
import { formatResponse } from "../utils/formatResponse.js";

dotenv.config();

export const signup = async (req, res) => {
  try {
    const { email, password, full_name, role_code } = req.body;

    // Create user using admin API
    const { data, error } = await supabase.auth.admin.createUser({
      email,
      password,
      email_confirm: true,
    });

    if (error) {
      return res.status(400).json(formatResponse(false, error.message));
    }

    const userId = data.user.id;

    /* CURSOR PATCH START */
    // Fetch role row
    const { data: roleRow, error: roleErr } = await supabase
      .from("roles")
      .select("*")
      .eq("role_code", role_code || "VIEWER")
      .single();

    if (roleErr || !roleRow) {
      return res.status(400).json(formatResponse(false, "Invalid role_code"));
    }

    // Determine user type
    const userType =
      roleRow.role_code === "SUPER" || roleRow.role_code === "ADMIN"
        ? "ADMIN_USER"
        : "APP_USER";

    // IMPORTANT: Only UPDATE profile, never INSERT
    const { error: profileUpdateErr } = await supabase
      .from("profiles")
      .update({
        full_name,
        role_id: roleRow.id,
        role_code: roleRow.role_code,
        user_type: userType,
        email_verified: true
      })
      .eq("id", userId);

    if (profileUpdateErr) {
      return res.status(400).json(formatResponse(false, profileUpdateErr.message));
    }
    /* CURSOR PATCH END */

    return res.status(201).json(
      formatResponse(true, "Signup successful", { userId })
    );
  } catch (err) {
    return res.status(500).json(formatResponse(false, err.message));
  }
};

export const login = async (req, res) => {
  try {
    const { email, password } = req.body;

    const { data, error } = await supabase.auth.signInWithPassword({
      email,
      password,
    });

    if (error) {
      return res.status(400).json(formatResponse(false, error.message));
    }

    // Fetch profile with role
    let { data: profile, error: profileError } = await supabase
      .from("profiles")
      .select("*, roles(role_code, name)")
      .eq("id", data.user.id)
      .single();

    /* CURSOR PATCH START */
    if (!profile) {
      const userId = data.user.id;
      
      // Get default role "VIEWER"
      const { data: roleRow, error: roleError } = await supabase
        .from("roles")
        .select("id, role_code")
        .eq("role_code", "VIEWER")
        .single();

      if (roleError || !roleRow) {
        return res.status(400).json(formatResponse(false, "Default role 'VIEWER' not found"));
      }

      // IMPORTANT: Only UPDATE profile, never INSERT
      await supabase.from("profiles").update({
        full_name: "New User",
        role_id: roleRow.id,
        role_code: roleRow.role_code,
        user_type:
          roleRow.role_code === "ADMIN" || roleRow.role_code === "SUPER"
            ? "ADMIN_USER"
            : "APP_USER",
        email_verified: true
      }).eq("id", userId);

      const { data: created } = await supabase
        .from("profiles")
        .select("*, roles(role_code)")
        .eq("id", userId)
        .single();

      profile = created;
    }
    /* CURSOR PATCH END */

    if (!profile) {
      return res.status(400).json(formatResponse(false, "Profile not found"));
    }

    /* CURSOR PATCH START */
    // Add role_code and user_type to profile (use profile.role_code if roles relationship missing)
    profile.role_code = profile.roles?.role_code || profile.role_code;
    profile.user_type = profile.user_type || (
      profile.role_code === "SUPER" || profile.role_code === "ADMIN"
        ? "ADMIN_USER"
        : "APP_USER"
    );
    /* CURSOR PATCH END */

    /* CURSOR PATCH START */
    // Generate JWT token with role_code and user_type
    const token = jwt.sign(
      {
        id: data.user.id,
        email: data.user.email,
        role: profile.roles?.role_code || profile.roles?.name || profile.role_code,
        role_code: profile.role_code,
        user_type: profile.user_type,
      },
      process.env.JWT_SECRET,
      { expiresIn: "7d" }
    );

    // Extract Supabase session tokens
    const access_token = data.session?.access_token || null;
    const refresh_token = data.session?.refresh_token || null;
    const expires_at = data.session?.expires_at || null;
    /* CURSOR PATCH END */

    return res.json(
      formatResponse(true, "Login successful", {
        token, // Custom JWT token
        access_token, // Supabase access token
        refresh_token, // Supabase refresh token
        expires_at, // Token expiration timestamp
        user: {
          id: data.user.id,
          email: data.user.email,
          full_name: profile.full_name,
          role: profile.roles,
          role_code: profile.role_code,
          user_type: profile.user_type,
        },
      })
    );
  } catch (err) {
    return res.status(500).json(formatResponse(false, err.message));
  }
};

/* CURSOR ADDED START: getMe and updateProfile functions */
export const getMe = async (req, res) => {
  try {
    const userId = req.user.id;

    const { data: profile, error } = await supabase
      .from("profiles")
      .select("*, roles(name, role_code, type)")
      .eq("id", userId)
      .single();

    if (error || !profile) {
      return res.status(404).json(formatResponse(false, "Profile not found"));
    }

    /* CURSOR PATCH START */
    // Add role_code and user_type to profile response
    profile.role_code = profile.roles?.role_code || profile.role_code;
    profile.user_type = profile.user_type || (
      profile.role_code === "SUPER" || profile.role_code === "ADMIN"
        ? "ADMIN_USER"
        : "APP_USER"
    );
    /* CURSOR PATCH END */

    return res.json(formatResponse(true, "Profile retrieved", profile));
  } catch (err) {
    return res.status(500).json(formatResponse(false, err.message));
  }
};

export const updateProfile = async (req, res) => {
  try {
    const userId = req.user.id;
    const { full_name, phone, avatar_url } = req.body;

    // Only allow specific fields to be updated
    const updateData = {};
    if (full_name !== undefined) updateData.full_name = full_name;
    if (phone !== undefined) updateData.phone = phone;
    if (avatar_url !== undefined) updateData.avatar_url = avatar_url;

    if (Object.keys(updateData).length === 0) {
      return res
        .status(400)
        .json(formatResponse(false, "No valid fields to update"));
    }

    const { data, error } = await supabase
      .from("profiles")
      .update(updateData)
      .eq("id", userId)
      .select()
      .single();

    if (error) {
      return res.status(400).json(formatResponse(false, error.message));
    }

    return res.json(formatResponse(true, "Profile updated successfully", data));
  } catch (err) {
    return res.status(500).json(formatResponse(false, err.message));
  }
};
/* CURSOR ADDED END */

/* CURSOR ADDED START: Additional auth functions - change-password, forgot-password, reset-password, refresh-token, logout, admin/create-user */
export const changePassword = async (req, res) => {
  try {
    const userId = req.user.id;
    const userEmail = req.user.email;
    const { old_password, new_password } = req.body;

    if (!old_password || !new_password) {
      return res
        .status(400)
        .json(formatResponse(false, "old_password and new_password are required"));
    }

    // Get user email if not in JWT
    let email = userEmail;
    if (!email) {
      const { data: userData, error: userError } =
        await supabase.auth.admin.getUserById(userId);
      if (userError || !userData?.user) {
        return res.status(404).json(formatResponse(false, "User not found"));
      }
      email = userData.user.email;
    }

    // Verify old password by attempting to sign in
    const { error: verifyError } = await supabase.auth.signInWithPassword({
      email,
      password: old_password,
    });

    if (verifyError) {
      return res
        .status(400)
        .json(formatResponse(false, "Current password is incorrect"));
    }

    // Update password using Supabase admin API
    const { error: updateError } = await supabase.auth.admin.updateUserById(
      userId,
      { password: new_password }
    );

    if (updateError) {
      return res
        .status(400)
        .json(formatResponse(false, updateError.message));
    }

    return res.json(formatResponse(true, "Password updated successfully"));
  } catch (err) {
    return res.status(500).json(formatResponse(false, err.message));
  }
};

export const forgotPassword = async (req, res) => {
  try {
    const { email } = req.body;

    if (!email) {
      return res
        .status(400)
        .json(formatResponse(false, "Email is required"));
    }

    // Send password reset email
    // Use current server port for redirect URL
    const serverPort = process.env.PORT || 5000;
    const redirectUrl = process.env.FRONTEND_URL || `http://localhost:${serverPort}`;
    
    const { error } = await supabase.auth.resetPasswordForEmail(email, {
      redirectTo: `${redirectUrl}/reset-password`,
    });

    if (error) {
      return res.status(400).json(formatResponse(false, error.message));
    }

    // Always return success for security (don't reveal if email exists)
    return res.json(
      formatResponse(
        true,
        "If an account with that email exists, a password reset link has been sent"
      )
    );
  } catch (err) {
    return res.status(500).json(formatResponse(false, err.message));
  }
};

export const resetPassword = async (req, res) => {
  try {
    const { access_token, new_password } = req.body;

    if (!access_token || !new_password) {
      return res
        .status(400)
        .json(formatResponse(false, "access_token and new_password are required"));
    }

    // Verify the token and get user info
    // The access_token from email is a recovery token
    const { data: userData, error: verifyError } = await supabase.auth.getUser(access_token);

    if (verifyError || !userData?.user) {
      return res
        .status(400)
        .json(formatResponse(false, "Invalid or expired reset token. Please request a new password reset link."));
    }

    const userId = userData.user.id;

    // Use admin API to update password directly (since we have service role key)
    const { error: updateError } = await supabase.auth.admin.updateUserById(userId, {
      password: new_password,
    });

    if (updateError) {
      return res.status(400).json(formatResponse(false, updateError.message));
    }

    return res.json(formatResponse(true, "Password reset successfully"));
  } catch (err) {
    return res.status(500).json(formatResponse(false, err.message));
  }
};

export const refreshToken = async (req, res) => {
  try {
    const { refresh_token } = req.body;

    if (!refresh_token) {
      return res
        .status(400)
        .json(formatResponse(false, "refresh_token is required"));
    }

    // Refresh the session
    const { data, error } = await supabase.auth.refreshSession({
      refresh_token,
    });

    if (error || !data.session) {
      return res
        .status(401)
        .json(formatResponse(false, "Invalid or expired refresh token"));
    }

    /* CURSOR PATCH START */
    // Generate new JWT token with role_code and user_type
    const { data: profile } = await supabase
      .from("profiles")
      .select("*, roles(role_code, name)")
      .eq("id", data.user.id)
      .single();

    if (!profile) {
      return res
        .status(404)
        .json(formatResponse(false, "Profile not found"));
    }

    // Ensure role_code and user_type are set
    const roleCode = profile.roles?.role_code || profile.role_code;
    const userType = profile.user_type || (
      roleCode === "SUPER" || roleCode === "ADMIN"
        ? "ADMIN_USER"
        : "APP_USER"
    );

    const token = jwt.sign(
      {
        id: data.user.id,
        email: data.user.email,
        role: roleCode || profile.roles?.name,
        role_code: roleCode,
        user_type: userType,
      },
      process.env.JWT_SECRET,
      { expiresIn: "7d" }
    );
    /* CURSOR PATCH END */

    return res.json(
      formatResponse(true, "Token refreshed successfully", {
        access_token: data.session.access_token,
        refresh_token: data.session.refresh_token,
        token, // JWT token for API use
        expires_at: data.session.expires_at,
      })
    );
  } catch (err) {
    return res.status(500).json(formatResponse(false, err.message));
  }
};

export const logout = async (req, res) => {
  try {
    // Sign out from Supabase
    const { error } = await supabase.auth.signOut();

    if (error) {
      return res.status(400).json(formatResponse(false, error.message));
    }

    return res.json(
      formatResponse(true, "Logged out successfully")
    );
  } catch (err) {
    return res.status(500).json(formatResponse(false, err.message));
  }
};

export const adminCreateUser = async (req, res) => {
  try {
    const { email, password, full_name, role_code } = req.body;

    if (!email || !password || !full_name || !role_code) {
      return res
        .status(400)
        .json(
          formatResponse(
            false,
            "email, password, full_name, and role_code are required"
          )
        );
    }

    /* CURSOR PATCH START */
    // Find role by role_code - get full role data
    const { data: roleData, error: roleError } = await supabase
      .from("roles")
      .select("*")
      .eq("role_code", role_code)
      .single();

    if (roleError || !roleData) {
      return res.status(400).json(formatResponse(false, "Invalid role_code"));
    }

    // Create user using admin API
    const { data, error } = await supabase.auth.admin.createUser({
      email,
      password,
      email_confirm: true,
    });

    if (error) {
      return res.status(400).json(formatResponse(false, error.message));
    }

    // IMPORTANT: Only UPDATE profile, never INSERT
    // Determine user type
    const userType =
      roleData.role_code === "SUPER" || roleData.role_code === "ADMIN"
        ? "ADMIN_USER"
        : "APP_USER";

    const { error: profileError } = await supabase
      .from("profiles")
      .update({
        full_name,
        role_id: roleData.id,
        role_code: roleData.role_code,
        user_type: userType,
        email_verified: true,
      })
      .eq("id", data.user.id);

    if (profileError) {
      // Cleanup: delete the created user if profile update fails
      await supabase.auth.admin.deleteUser(data.user.id);
      return res.status(400).json(formatResponse(false, profileError.message));
    }
    /* CURSOR PATCH END */

    return res.status(201).json(
      formatResponse(true, "User created successfully", {
        userId: data.user.id,
        email: data.user.email,
      })
    );
  } catch (err) {
    return res.status(500).json(formatResponse(false, err.message));
  }
};
/* CURSOR ADDED END */