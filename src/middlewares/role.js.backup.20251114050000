import { supabase } from "../config/supabaseClient.js";

export const requireRole = (allowedRoles) => {
  return async (req, res, next) => {
    try {
      const userId = req.user.id;

      /* CURSOR ADDED START: Enhanced to check both role name and role_code */
      const { data: profile } = await supabase
        .from("profiles")
        .select("role_id, roles(name, role_code)")
        .eq("id", userId)
        .single();

      if (!profile) return res.status(401).json({ error: "Profile not found" });

      const roleName = profile.roles?.name;
      const roleCode = profile.roles?.role_code;

      // Check if user's role (name or code) is in allowed roles
      const hasAccess =
        allowedRoles.includes(roleName) || allowedRoles.includes(roleCode);

      if (!hasAccess) {
        return res.status(403).json({ error: "Access denied" });
      }
      /* CURSOR ADDED END */

      next();
    } catch (err) {
      res.status(500).json({ error: err.message });
    }
  };
};